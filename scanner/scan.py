import os
import yara

RULES_PATH = 'scanner/signature_database/integrated_rules.yar'

def compile_rules():
    try:
        rules = yara.compile(filepath=RULES_PATH)
        return rules
    except yara.SyntaxError as e:
        print(f"Error compiling YARA rules: {e}")
        return None

def scan_file(file_path, rules):
    try:
        matches = rules.match(filepath=file_path)
        return [f"Malware detected in {file_path}: {match}" for match in matches]
    except yara.Error as e:
        print(f"Error scanning file {file_path}: {e}")
        return None

def scan_directory(directory_path, rules):
    results = []
    for root, dirs, files in os.walk(directory_path):
        for file in files:
            file_path = os.path.join(root, file)
            file_results = scan_file(file_path, rules)
            if file_results:
                results.extend(file_results)
    return results

def scan_system():
    rules = compile_rules()
    if rules:
        return scan_directory('/', rules)
    else:
        return ["Error compiling YARA rules"]
